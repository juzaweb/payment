class PaymentForm{stripe=null;constructor(e,t="#payment-form",r={}){this.module=e,this.element=t,this.paymentMethod=$('[name="method"]'),this.options=r,this.init()}init(){const e=this;$(document).on("submit",this.element,async function(t){if(t.isDefaultPrevented())return!1;t.preventDefault();let r=$(this),s=new FormData(r[0]),n=r.find("button[type=submit]"),a=n.html(),o=n.find("i").attr("class");if($("#payment-message").empty(),n.find("i").attr("class","fa fa-spinner fa-spin"),n.prop("disabled",!0),n.data("loading-text")&&n.html('<i class="fa fa-spinner fa-spin"></i> '+n.data("loading-text")),"Stripe"===s.get("method")){const{token:t,error:r}=await e.getStripe().createToken(e.cardNumber,{name:document.getElementById("cardholder-name").value});r?e.sendMessageByResponse({success:!1,message:r.message}):s.set("token",t.id)}$.ajax({type:r.attr("method"),url:r.attr("action"),dataType:"json",data:s,cache:!1,contentType:!1,processData:!1,success:function(t){if(t.redirect)return setTimeout(function(){window.location=t.redirect},1e3),!1;if(n.find("i").attr("class",o),n.prop("disabled",!1),n.data("loading-text")&&n.html(a),!1===t.success)return!1;if("redirect"===t.type)return window.location.href=t.redirect,!1;if("embed"===t.type){let s=`<iframe src="${t.embed_url}" width="100%" height="350px" frameborder="0"></iframe>`;return $("#payment-container").length?$("#payment-container").html(s):r.html(s),e.checkStatus(t.payment_history_id),!1}e.options.onSuccess?e.options.onSuccess(t):e.sendMessageByResponse(t)},error:function(t,r,s){let i=t.responseJSON;n.find("i").attr("class",o),n.prop("disabled",!1),n.data("loading-text")&&n.html(a),e.options.onError&&e.options.onError(i)}})}),this.paymentMethod.on("change",function(t){if("Stripe"===$(this).val()){const t=e.getStripe();if(!t)return;let r=`<div class="form-group">\n                    <label for="cardholder-name">${e.options.language.cardholder_name}</label>\n                    <input id="cardholder-name" class="form-control" type="text" placeholder="John Doe" required>\n                </div>\n\n                <div class="form-group">\n                    <label for="card-number">${e.options.language.card_number}</label>\n                    <div id="card-number" class="form-control"></div>\n                </div>\n\n                <div class="form-group">\n                    <label for="card-expiry">${e.options.language.expiry_date}</label>\n                    <div id="card-expiry" class="form-control"></div>\n                </div>\n\n                <div class="form-group">\n                    <label for="card-cvc">${e.options.language.cvc}</label>\n                    <div id="card-cvc" class="form-control"></div>\n                </div>\n\n                <small id="card-errors" class="form-text text-danger mb-3"></small>`;$("#form-card").html(r);const s=t.elements(),n={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#dc3545",iconColor:"#dc3545"}};e.cardNumber=s.create("cardNumber",{style:n}),e.cardNumber.mount("#card-number"),e.cardExpiry=s.create("cardExpiry",{style:n}),e.cardExpiry.mount("#card-expiry"),e.cardCvc=s.create("cardCvc",{style:n}),e.cardCvc.mount("#card-cvc"),[e.cardNumber,e.cardExpiry,e.cardCvc].forEach(e=>{e.on("change",function(e){document.getElementById("card-errors").textContent=e.error?e.error.message:""})})}else $("#form-card").html(""),e.cardNumber=null,e.cardExpiry=null,e.cardCvc=null})}checkStatus(e){const t=this;let r=setInterval(function(){$.ajax({type:"GET",url:`/payment/${t.module}/status/${e}`,dataType:"json",success:function(e){let s=e.status;"pending"!==s&&"processing"!==s&&(t.options.onSuccess&&"success"===s&&t.options.onSuccess(e),"failed"===s&&t.options.onError&&t.options.onError(e),clearInterval(r))}.bind(this),error:function(e){t.options.onError&&t.options.onError(e),clearInterval(r)}.bind(this)})},2e3)}sendMessageByResponse(e){let t=get_message_response(e);console.log(t),t&&$("#payment-message").html(`<div class="alert alert-${t.success?"success":"danger"}">${t.message}</div>`)}getStripe(){return this.stripe?this.stripe:this.options.stripePublishKey?(this.stripe=Stripe(this.options.stripePublishKey),this.stripe):(this.sendMessageByResponse({success:!1,message:this.options.language.stripe_publish_key_not_set}),null)}}
